# 量化交易系统 - 代码阅读指南

## 目录
1. [项目概述](#项目概述)
2. [项目结构](#项目结构)
3. [核心模块详解](#核心模块详解)
4. [策略开发指南](#策略开发指南)
   - [如何开发自定义选股策略](#如何开发自定义选股策略)
   - [如何开发自定义交易策略](#如何开发自定义交易策略)
   - [仓位控制与风险管理](#仓位控制与风险管理)
5. [回测流程详解](#回测流程详解)
6. [常见使用示例](#常见使用示例)
7. [指标说明](#指标说明)

---

## 项目概述

本项目是一个完整的量化交易回测系统，支持自定义选股策略和交易策略，通过历史数据验证策略效果。

### 核心设计理念
- **选股策略**：决定"买什么"
- **交易策略**：决定"何时买卖"
- **回测引擎**：模拟真实交易环境，计算绩效指标

### 适用场景
- A股主板股票（自动过滤科创板、创业板）
- 短线、中线、长线交易
- 趋势跟踪、动量交易、突破交易等

---

## 项目结构

```
quant_project/
├── src/
│   └── quant_project/
│       ├── __init__.py              # 包初始化
│       ├── backtest.py             # 核心回测引擎
│       ├── backtest_runner.py      # 命令行入口
│       ├── data_loader.py          # 数据获取模块
│       ├── analysis.py             # 回测结果分析
│       ├── stock_selector.py       # 简单选股器
│       └── strategies/            # 策略模块
│           ├── __init__.py        # 策略导出
│           ├── base.py            # 策略基类
│           ├── selection.py       # 选股策略
│           ├── trading.py         # 交易策略
│           ├── high_yield.py     # 高收益策略（5日10%）
│           └── limit_up.py       # 涨停板打板策略（高风险）
├── examples/                     # 示例代码
│   ├── backtest_example.py      # 回测示例
│   └── limit_up_example.py      # 打板策略示例
└── docs/                         # 文档目录
    ├── 代码阅读指南.md          # 本文件
    ├── LIMIT_UP_STRATEGY.md     # 打板策略详细说明
    └── ...                      # 其他文档
```

---

## 核心模块详解

### 1. backtest.py - 回测引擎

**核心类：**
- `BacktestConfig`: 回测配置
- `Trade`: 交易记录
- `Position`: 持仓记录
- `BacktestResult`: 回测结果
- `BacktestEngine`: 回测引擎

**关键方法：**

| 方法 | 说明 |
|-----|------|
| `BacktestEngine.run()` | 运行回测，逐日模拟交易 |
| `_get_rebalance_dates()` | 根据频率计算调仓日期 |
| `_calculate_commission()` | 计算交易佣金 |
| `_calculate_metrics()` | 计算绩效指标 |

**执行流程：**
```
1. 初始化账户状态（现金、持仓、记录）
2. 确定调仓日期（周/月/季）
3. 逐日循环：
   a. 检查交易策略的卖出信号
   b. 调仓日：清空当前持仓
   c. 调仓日：选股并买入新股票
   d. 计算当日净值
4. 处理未平仓持仓
5. 计算绩效指标
```

### 2. strategies/base.py - 策略基类

**BaseSelectionStrategy（选股策略基类）**
```python
class BaseSelectionStrategy(ABC):
    @abstractmethod
    def select(self, data, date, max_stocks=None) -> List[str]:
        """
        输入：所有股票历史数据、选股日期、最大选股数
        输出：符合条件的股票代码列表，如 ["sh601988", "sz000001"]
        """
        pass
```

**BaseTradingStrategy（交易策略基类）**
```python
class BaseTradingStrategy(ABC):
    @abstractmethod
    def generate_signals(self, data, entry_date, exit_date) -> pd.DataFrame:
        """
        输入：单只股票从入场到出场的数据
        输出：每日信号，包含 date 和 signal 列
        signal: 1=持有, 0=卖出, -1=强制退出
        """
        pass
```

**信号常量：**
- `Signal.HOLD = 1` - 继续持有
- `Signal.SELL = 0` - 卖出信号
- `Signal.EXIT = -1` - 强制退出（止损/止盈）

### 3. strategies/selection.py - 选股策略

**所有可用的选股策略总览：**

| 策略名称 | 文件位置 | 说明 | 风险级别 | 适用场景 |
|----------|---------|------|---------|---------|
| PriceRangeSelectionStrategy | selection.py | 价格区间筛选 | 低 | 作为基础筛选层 |
| MovingAverageSelectionStrategy | selection.py | 均线金叉/死叉 | 中 | 趋势市场顺势交易 |
| MomentumSelectionStrategy | selection.py | 动量排名 | 中 | 追逐强势股 |
| HighYieldShortTermSelectionStrategy | high_yield.py | 中短期高收益 | 中高 | 5日持有期，目标10%+ |
| MomentumBreakthroughSelectionStrategy | high_yield.py | 动量突破 | 中高 | 强势股突破 |
| **LimitUpSelectionStrategy** | limit_up.py | **涨停板打板** | **高** | **捕捉临近涨停** |

**均线参数建议：**
- 5日/20日：短线金叉
- 10日/30日：中线金叉
- 20日/60日：长线金叉

### 4. strategies/trading.py - 交易策略

**所有可用的交易策略总览：**

| 策略名称 | 文件位置 | 说明 | 持有周期 | 适用场景 |
|----------|---------|------|---------|---------|
| HoldTradingStrategy | trading.py | 固定持有到调仓日 | 长期 | 基准对比 |
| FixedStopLossTradingStrategy | trading.py | 固定止损/止盈 | 灵活 | 最常用 |
| MovingAverageCrossTradingStrategy | trading.py | 均线交叉跟踪 | 中期 | 趋势跟踪 |
| ATRStopLossTradingStrategy | trading.py | ATR动态止损 | 灵活 | 波动大市场 |
| FiveDayHoldTradingStrategy | high_yield.py | 5日固定持有 | 5天 | 短期高收益 |
| **LimitUpTradingStrategy** | limit_up.py | **涨停板交易** | **1-3天** | **打板快进快出** |

**ATR止损倍数建议：**
- 1.5：较保守，止损频繁
- 2.0：标准设置
- 3.0：较宽松，减少止损频率

### 5. strategies/high_yield.py - 高收益策略

**策略定位：** 5日持有期，目标收益率 >= 10%

**核心策略：**
- `HighYieldShortTermSelectionStrategy` - 综合选股策略
- `FiveDayHoldTradingStrategy` - 5日持有交易策略
- `MomentumBreakthroughSelectionStrategy` - 动量突破策略

**主板过滤：**
```python
def is_main_board(symbol: str) -> bool:
    """只选择主板股票，排除科创板和创业板"""
    # 上海主板：600xxx, 601xxx, 603xxx, 605xxx
    # 深圳主板：000xxx, 001xxx
    # 科创板：688xxx（排除）
    # 创业板：300xxx（排除）
```

### 6. strategies/limit_up.py - 涨停板打板策略

**策略定位：** 高风险高收益的短线打板玩法，捕捉临近涨停的股票

**核心策略：**
- `LimitUpSelectionStrategy` - 涨停板选股策略
- `LimitUpTradingStrategy` - 涨停板交易策略

**选股特点：**
- 涨幅筛选：7%-9.5%（接近涨停但未完全封板）
- 量能放大：量比 >= 1.5倍
- 突破确认：突破10天高点
- 技术确认：MACD金叉或柱状图为正
- 主板限制：排除ST、科创板、创业板

**交易特点：**
- 持有周期：1-3天（快进快出）
- 严格止损：亏损5%立即止损
- 快速止盈：第二天盈利3%立即止盈
- 移动止盈：盈利8%启动移动止盈（回撤8%）
- 强制退出：第3个交易日收盘时必须退出

**仓位控制：**
- 最多持仓：3只股票
- 总仓位：≤83%（每只约27.7%）
- 调仓频率：建议每周调仓

**风险提示：**
⚠️ **这是高风险策略，适合激进投资者！**
- 打板失败风险：涨停可能打开，次日低开
- 流动性风险：高位接盘，可能无法及时卖出
- 波动风险：短线波动剧烈，容易触发止损
- 建议小资金试水，严格执行止损

**使用示例：**
```python
from quant_project.strategies import LimitUpSelectionStrategy, LimitUpTradingStrategy

selection = LimitUpSelectionStrategy(
    min_pct_chg=7.0,      # 最低涨幅7%
    max_pct_chg=9.8,      # 最高涨幅9.8%
    min_volume_ratio=1.5, # 量比1.5倍
)

trading = LimitUpTradingStrategy(
    hold_days=3,          # 最长持有3天
    stop_loss_pct=0.05,   # 止损5%
    quick_profit_pct=0.03,# 快速止盈3%
)

config = BacktestConfig(
    max_stocks=3,         # 最多3只（关键！）
    rebalance_frequency="weekly",
)
```

详细文档请参考：[LIMIT_UP_STRATEGY.md](LIMIT_UP_STRATEGY.md)

---

## 策略开发指南

### 如何开发自定义选股策略

```python
from .base import BaseSelectionStrategy

class MySelectionStrategy(BaseSelectionStrategy):
    def select(self, data, date, max_stocks=None):
        candidates = []

        for symbol in data["symbol"].unique():
            # 过滤ST股票
            if "ST" in symbol:
                continue

            # 只选择主板股票
            if not is_main_board(symbol):
                continue

            stock_data = data[data["symbol"] == symbol].sort_values("date")
            stock_data = stock_data[stock_data["date"] <= date]

            # 你的选股逻辑
            # 1. 涨幅筛选
            # 2. 技术指标筛选
            # 3. 成交量筛选
            # ...

            if 符合条件:
                candidates.append(symbol)

        # 按某种标准排序
        candidates.sort(key=... reverse=True)

        if max_stocks:
            candidates = candidates[:max_stocks]

        return candidates
```

### 如何开发自定义交易策略

```python
from .base import BaseTradingStrategy, Signal

class MyTradingStrategy(BaseTradingStrategy):
    def generate_signals(self, data, entry_date, exit_date):
        # 获取入场到出场期间的数据
        mask = (data["date"] >= entry_date) & (data["date"] <= exit_date)
        trading_data = data[mask].copy().sort_values("date")

        signals = []
        exited = False

        for _, row in trading_data.iterrows():
            if exited:
                signals.append({"date": row["date"], "signal": Signal.SELL})
            else:
                # 你的交易逻辑
                # 1. 止损检查
                # 2. 止盈检查
                # 3. 技术指标信号
                # ...

                if 需要卖出:
                    signals.append({"date": row["date"], "signal": Signal.EXIT})
                    exited = True
                else:
                    signals.append({"date": row["date"], "signal": Signal.HOLD})

        return pd.DataFrame(signals)
```

### 仓位控制与风险管理

**仓位控制的重要性：**
- 分散风险，避免单一股票波动过大
- 控制总体风险暴露
- 保留现金应对意外情况

**如何设置仓位：**
```python
config = BacktestConfig(
    initial_capital=100000,   # 初始资金
    max_stocks=3,             # 最多持仓3只
    # 资金会自动平均分配给max_stocks只股票
)

# 示例：10万资金，max_stocks=3
# - 每只股票分配：100000 / 3 ≈ 33333元
# - 每只占比：33.3%
# - 总仓位：100%（满仓时）

# 控制总仓位在83%以下：
# - 每只股票：100000 * 0.83 / 3 ≈ 27667元
# - 每只占比：27.7%
# - 总仓位：83%（留17%现金）
```

**不同策略的仓位建议：**
- **保守策略**：max_stocks=8-10，分散风险
- **中性策略**：max_stocks=5-8，平衡风险收益
- **激进策略**：max_stocks=3-5，集中持仓
- **打板策略**：max_stocks=2-3，严格控制

**实现自定义仓位分配：**
```python
# 回测引擎默认使用等权重分配
# 如需自定义分配，可在交易策略中实现
# 或修改BacktestEngine的资金分配逻辑
```

---

## 回测流程详解

### 回测核心逻辑

```python
# 1. 初始化
cash = initial_capital          # 可用现金
holdings = {}                   # 持仓字典 {symbol: shares}
entry_prices = {}               # 入场价格
entry_dates = {}                # 入场日期

# 2. 逐日循环
for date in trading_dates:
    # 处理卖出信号
    if 交易策略发出卖出信号:
        卖出股票
        更新现金
        记录交易和持仓

    # 调仓日
    if date in 调仓日期:
        # 清空当前持仓
        卖出所有持仓

        # 选股并买入
        selected = 选股策略.select(data, date)
        for symbol in selected:
            买入股票
            更新持仓

    # 计算当日净值
    equity = cash + sum(持仓市值)
    记录净值曲线

# 3. 计算绩效指标
total_return = (期末净值 - 期初净值) / 期初净值
annual_return = (期末净值/期初净值)^(1/年数) - 1
max_drawdown = 最小回撤
sharpe_ratio = (日收益率均值 / 日收益率标准差) * sqrt(252)
win_rate = 盈利持仓数 / 总持仓数
```

### 交易时机说明

- **买入价格**：开盘价（更保守）
- **卖出价格**：开盘价（止损时）或收盘价（结算时）
- **持仓价值**：收盘价计算
- **滑点**：买入时价+滑点，卖出时价-滑点

---

## 常见使用示例

### 示例1：使用高收益策略进行回测

```python
from quant_project.strategies import (
    HighYieldShortTermSelectionStrategy,
    FiveDayHoldTradingStrategy,
)
from quant_project.backtest import BacktestEngine, BacktestConfig

# 创建选股策略
selection_strategy = HighYieldShortTermSelectionStrategy(
    min_price=3.0,
    max_price=50.0,
    lookback_days=5,
    min_return=3.0,
    max_return=15.0,
)

# 创建交易策略
trading_strategy = FiveDayHoldTradingStrategy(
    hold_days=5,
    stop_loss_pct=0.05,
    trail_profit_pct=0.08,
)

# 配置回测
config = BacktestConfig(
    start_date="2024-01-01",
    end_date="2024-12-31",
    selection_strategy=selection_strategy,
    trading_strategy=trading_strategy,
    initial_capital=100000,
    max_stocks=5,
    rebalance_frequency="weekly",
    commission_rate=0.0003,
    slippage=0.001,
)

# 运行回测
engine = BacktestEngine(config)
data = fetch_for_backtest(start_date, end_date, max_stocks=100)
result = engine.run(data)

# 输出结果
from quant_project.analysis import BacktestAnalyzer
analyzer = BacktestAnalyzer(result)
analyzer.print_summary()
```

### 示例2：使用命令行回测

```bash
# 基础策略回测
python -m quant_project.backtest_runner \
    --start 2024-01-01 \
    --end 2024-12-31 \
    --selection price_range \
    --min-price 5 \
    --max-price 50 \
    --trading fixed_stop_loss \
    --stop-loss 0.05

# 动量选股 + ATR止损
python -m quant_project.backtest_runner \
    --start 2024-01-01 \
    --end 2024-12-31 \
    --selection momentum \
    --momentum-period 20 \
    --top-n 10 \
    --trading atr_stop_loss \
    --atr-multiplier 2.0
```

### 示例3：涨停板打板策略回测

```python
from quant_project.strategies import (
    LimitUpSelectionStrategy,
    LimitUpTradingStrategy,
)
from quant_project.backtest import BacktestEngine, BacktestConfig
from quant_project.data_loader import fetch_for_backtest

# 创建选股策略：捕捉临近涨停的股票
selection_strategy = LimitUpSelectionStrategy(
    min_pct_chg=7.0,          # 最低涨幅7%
    max_pct_chg=9.8,          # 最高涨幅9.8%（接近但未封板）
    min_volume_ratio=1.5,     # 量比至少1.5倍
    min_amount=5000,          # 最小成交额5000万
    use_breakout=True,        # 要求突破近期高点
    use_macd=True,            # 使用MACD确认
)

# 创建交易策略：短期快进快出
trading_strategy = LimitUpTradingStrategy(
    hold_days=3,              # 最长持有3天
    stop_loss_pct=0.05,       # 止损5%
    quick_profit_pct=0.03,    # 第二天快速止盈3%
    trail_profit_pct=0.08,    # 移动止盈启动8%
)

# 配置回测（关键：max_stocks=3，控制仓位）
config = BacktestConfig(
    start_date="2024-01-01",
    end_date="2024-12-31",
    selection_strategy=selection_strategy,
    trading_strategy=trading_strategy,
    initial_capital=100000,      # 初始资金10万
    max_stocks=3,                # 最多持仓3只（仓位控制）
    rebalance_frequency="weekly",  # 每周调仓
    commission_rate=0.0003,      # 佣金万三
    slippage=0.01,               # 滑点1%（打板滑点较大）
)

# 运行回测
engine = BacktestEngine(config)
data = fetch_for_backtest("2024-01-01", "2024-12-31", max_stocks=200)
result = engine.run(data)

# 输出结果
from quant_project.analysis import BacktestAnalyzer
analyzer = BacktestAnalyzer(result)
analyzer.print_summary()
analyzer.generate_report()

# 仓位控制验证
print("\n仓位验证：")
print(f"总仓位：≤83%")
print(f"每只股票：≈27.7%")
print(f"同时持仓：≤3只")
```

**快速运行打板策略示例：**
```bash
# 完整回测
uv run python examples/limit_up_example.py 1

# 快速测试（小数据集）
uv run python examples/limit_up_example.py 2

# 更激进参数
uv run python examples/limit_up_example.py 3
```

### 示例4：测试主板过滤

```python
from quant_project.strategies import is_main_board

test_codes = [
    "sh600000",  # 上海主板 -> True
    "sz000001",  # 深圳主板 -> True
    "sh688981",  # 科创板 -> False
    "sz300750",  # 创业板 -> False
]

for code in test_codes:
    result = is_main_board(code)
    print(f"{code}: {'主板' if result else '非主板'}")
```

---

## 指标说明

### 绩效指标

| 指标 | 计算公式 | 说明 |
|-------|---------|------|
| 总收益率 | (期末净值 - 期初净值) / 期初净值 | 整体收益水平 |
| 年化收益率 | (期末净值/期初净值)^(1/年数) - 1 | 便于不同周期对比 |
| 最大回撤 | min((净值 - 历史最高) / 历史最高) | 最坏情况下的亏损 |
| 夏普比率 | (日收益率均值 / 标准差) * sqrt(252) | 单位风险收益 |
| 胜率 | 盈利持仓数 / 总持仓数 | 交易准确度 |

### 技术指标

#### RSI（相对强弱指标）
- 范围：0-100
- 超买区：>70
- 超卖区：<30
- 中性区：30-70

#### MACD（指数平滑异同移动平均线）
- DIF = EMA(12) - EMA(26)
- DEA = EMA(DIF, 9)
- MACD = 2 * (DIF - DEA)
- 金叉：DIF上穿DEA
- 死叉：DIF下穿DEA

#### ATR（平均真实波幅）
- TR = max(最高-最低, |最高-前收盘|, |最低-前收盘|)
- ATR = MA(TR, N)
- 用途：动态止损、波动性分析

---

## 注意事项

### 数据要求
- 必须包含列：date, symbol, open, high, low, close, volume, amount
- 按日期升序排列
- 建议使用前复权数据（adjust="hfq"）

### 风险提示
- 回测结果不等于实盘收益
- 需考虑滑点、冲击成本
- 过度拟合可能导致实盘亏损
- 建议样本外测试验证

### 交易成本
- 佣金：默认万三（0.03%）
- 最低佣金：部分券商5元/笔
- 滑点：默认0%，可设置

---

## 扩展阅读

- [LIMIT_UP_STRATEGY.md](LIMIT_UP_STRATEGY.md) - **涨停板打板策略详细说明**
- [基础知识.md](基础知识.md) - 量化交易基础知识
- [交易纪律.md](交易纪律.md) - 交易原则和纪律
- [基于Python的量化学习.md](基于Python的量化学习.md) - Python量化学习资源
